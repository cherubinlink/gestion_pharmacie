{% extends 'navigateur/base.html' %}
{% load static %}

{% block title %}Inscription - {{ page_title|default:"Créer un compte" }}{% endblock %}

{% block pharmacie %}

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">

      <!-- Logo -->
      <div class="text-center mb-4">
        <a href="{% url 'gestion_compte:connexion' %}">
          <img src="{% static 'assets/images/logo-dark.svg' %}" alt="Logo" style="max-width:150px;">
        </a>
      </div>

      <!-- Card principale -->
      <div class="card shadow-sm">
        <div class="card-body p-4">

          <h3 class="mb-1 text-center"><b>Créer un compte</b></h3>
          <p class="text-center text-muted small mb-4">
            Rejoignez notre plateforme de gestion pharmacie
          </p>

          <!-- Messages Django -->
          {% if messages %}
            <div id="messages-container">
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <!-- Formulaire d'inscription -->
          <form method="POST" enctype="multipart/form-data" id="form-inscription" novalidate>
            {% csrf_token %}

            <!-- Informations personnelles -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Prénom <span class="text-danger">*</span></label>
                  <input type="text" 
                         name="first_name" 
                         id="id_first_name"
                         class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" 
                         placeholder="Jean"
                         value="{{ form.first_name.value|default:'' }}"
                         required>
                  {% if form.first_name.errors %}
                    <div class="invalid-feedback">
                      {% for error in form.first_name.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Nom <span class="text-danger">*</span></label>
                  <input type="text" 
                         name="last_name" 
                         id="id_last_name"
                         class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" 
                         placeholder="Dupont"
                         value="{{ form.last_name.value|default:'' }}"
                         required>
                  {% if form.last_name.errors %}
                    <div class="invalid-feedback">
                      {% for error in form.last_name.errors %}{{ error }}{% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Email avec vérification temps réel -->
            <div class="mb-3">
              <label class="form-label">Adresse email <span class="text-danger">*</span></label>
              <input type="email" 
                     name="email" 
                     id="id_email"
                     class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                     placeholder="exemple@email.com"
                     value="{{ form.email.value|default:'' }}"
                     required>
              <div id="email-feedback" class="form-text"></div>
              {% if form.email.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.email.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Téléphone -->
            <div class="mb-3">
              <label class="form-label">Téléphone <span class="text-danger">*</span></label>
              <input type="tel" 
                     name="telephone" 
                     id="id_telephone"
                     class="form-control {% if form.telephone.errors %}is-invalid{% endif %}" 
                     placeholder="+237 6XX XX XX XX"
                     value="{{ form.telephone.value|default:'' }}"
                     required>
              <small class="form-text text-muted">Format: +237 6XX XX XX XX</small>
              {% if form.telephone.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.telephone.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Mot de passe avec indicateur de force -->
            <div class="mb-3">
              <label class="form-label">Mot de passe <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="password" 
                       name="password1" 
                       id="id_password1"
                       class="form-control {% if form.password1.errors %}is-invalid{% endif %}" 
                       placeholder="••••••••"
                       required>
                <button class="btn btn-outline-secondary" type="button" id="toggle-password1">
                  <i class="fas fa-eye" id="eye-icon1"></i>
                </button>
              </div>
              
              <!-- Indicateur de force -->
              <div id="password-strength" class="mt-2"></div>
              
              <small class="form-text text-muted">
                Min. 8 caractères avec majuscule, minuscule et chiffre
              </small>
              {% if form.password1.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.password1.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Confirmation mot de passe -->
            <div class="mb-3">
              <label class="form-label">Confirmer le mot de passe <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="password" 
                       name="password2" 
                       id="id_password2"
                       class="form-control {% if form.password2.errors %}is-invalid{% endif %}" 
                       placeholder="••••••••"
                       required>
                <button class="btn btn-outline-secondary" type="button" id="toggle-password2">
                  <i class="fas fa-eye" id="eye-icon2"></i>
                </button>
              </div>
              <div id="password2-feedback" class="form-text"></div>
              {% if form.password2.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.password2.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Informations complémentaires (optionnel - collapsible) -->
            <div class="mb-3">
              <a class="text-primary small" data-bs-toggle="collapse" href="#infos-complementaires" role="button">
                <i class="fas fa-plus-circle me-1"></i> Ajouter des informations complémentaires (optionnel)
              </a>
              
              <div class="collapse mt-3" id="infos-complementaires">
                <!-- WhatsApp -->
                <div class="mb-3">
                  <label class="form-label">WhatsApp</label>
                  <input type="tel" 
                         name="whatsapp" 
                         id="id_whatsapp"
                         class="form-control" 
                         placeholder="+237 6XX XX XX XX"
                         value="{{ form.whatsapp.value|default:'' }}">
                  <small class="form-text text-muted">Pour notifications WhatsApp</small>
                </div>

                <!-- Photo de profil -->
                <div class="mb-3">
                  <label class="form-label">Photo de profil</label>
                  <input type="file" 
                         name="photo" 
                         id="id_photo"
                         class="form-control" 
                         accept="image/*">
                  <small class="form-text text-muted">JPG, PNG (max 5MB)</small>
                </div>

                <div class="row">
                  <!-- Ville -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Ville</label>
                      <input type="text" 
                             name="ville" 
                             id="id_ville"
                             class="form-control" 
                             placeholder="Douala"
                             value="{{ form.ville.value|default:'' }}">
                    </div>
                  </div>

                  <!-- Pays -->
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Pays</label>
                      <input type="text" 
                             name="pays" 
                             id="id_pays"
                             class="form-control" 
                             value="{{ form.pays.value|default:'Cameroun' }}">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Conditions d'utilisation -->
            <div class="form-check mb-3">
              <input class="form-check-input" 
                     type="checkbox" 
                     name="accepter_conditions"
                     id="accepter_conditions" 
                     required>
              <label class="form-check-label small" for="accepter_conditions">
                J'accepte les <a href="#" class="text-primary" target="_blank">conditions d'utilisation</a> 
                et la <a href="#" class="text-primary" target="_blank">politique de confidentialité</a>
                <span class="text-danger">*</span>
              </label>
              {% if form.accepter_conditions.errors %}
                <div class="text-danger small">
                  {% for error in form.accepter_conditions.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Bouton de soumission -->
            <div class="d-grid mt-4">
              <button type="submit" class="btn btn-primary btn-lg" id="btn-submit">
                <i class="fas fa-user-plus me-2"></i> Créer mon compte
              </button>
            </div>

            <!-- Lien connexion -->
            <p class="text-center text-muted small mt-3 mb-0">
              Vous avez déjà un compte ? 
              <a href="{% url 'gestion_compte:connexion' %}" class="text-primary fw-bold">
                Se connecter
              </a>
            </p>

          </form>

        </div>
      </div>

      <!-- Statistiques (optionnel) -->
      {% if stats %}
      <div class="card shadow-sm mt-3">
        <div class="card-body p-3">
          <div class="row text-center">
            <div class="col-6">
              <h5 class="mb-0 text-primary">{{ stats.total_utilisateurs }}</h5>
              <small class="text-muted">Utilisateurs</small>
            </div>
            <div class="col-6">
              <h5 class="mb-0 text-success">{{ stats.inscriptions_mois }}</h5>
              <small class="text-muted">Ce mois</small>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Footer -->
      <div class="text-center mt-4">
        <p class="m-0 text-muted small">
          © {{ now|date:"Y" }} – Gestion Pharmacie – Tous droits réservés
        </p>
      </div>

    </div>
  </div>
</div>

<!-- JavaScript pour validation temps réel -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-inscription');
    const emailInput = document.getElementById('id_email');
    const password1Input = document.getElementById('id_password1');
    const password2Input = document.getElementById('id_password2');
    const btnSubmit = document.getElementById('btn-submit');

    // ============================================
    // 1. VÉRIFICATION EMAIL DISPONIBLE
    // ============================================
    let emailTimeout;
    emailInput.addEventListener('input', function() {
        clearTimeout(emailTimeout);
        const email = this.value.trim();
        const feedback = document.getElementById('email-feedback');

        if (!email) {
            feedback.textContent = '';
            this.classList.remove('is-valid', 'is-invalid');
            return;
        }

        // Vérifier format basique
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            feedback.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> Format email invalide</span>';
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
            return;
        }

        // Vérifier disponibilité après 500ms
        emailTimeout = setTimeout(() => {
            fetch(`{% url 'gestion_compte:verifier_email' %}?email=${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.disponible) {
                        feedback.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Email disponible</span>';
                        emailInput.classList.add('is-valid');
                        emailInput.classList.remove('is-invalid');
                    } else {
                        feedback.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> ' + data.message + '</span>';
                        emailInput.classList.add('is-invalid');
                        emailInput.classList.remove('is-valid');
                    }
                })
                .catch(error => {
                    console.error('Erreur vérification email:', error);
                });
        }, 500);
    });

    // ============================================
    // 2. INDICATEUR FORCE MOT DE PASSE
    // ============================================
    password1Input.addEventListener('input', function() {
        const password = this.value;
        const strengthDiv = document.getElementById('password-strength');
        
        if (!password) {
            strengthDiv.innerHTML = '';
            return;
        }

        let force = 0;
        let criteres = [];

        // Vérifier critères
        if (password.length >= 8) {
            force++;
            criteres.push('<i class="fas fa-check text-success"></i> 8+ caractères');
        } else {
            criteres.push('<i class="fas fa-times text-danger"></i> 8+ caractères');
        }

        if (/[A-Z]/.test(password)) {
            force++;
            criteres.push('<i class="fas fa-check text-success"></i> Majuscule');
        } else {
            criteres.push('<i class="fas fa-times text-danger"></i> Majuscule');
        }

        if (/[a-z]/.test(password)) {
            force++;
            criteres.push('<i class="fas fa-check text-success"></i> Minuscule');
        } else {
            criteres.push('<i class="fas fa-times text-danger"></i> Minuscule');
        }

        if (/[0-9]/.test(password)) {
            force++;
            criteres.push('<i class="fas fa-check text-success"></i> Chiffre');
        } else {
            criteres.push('<i class="fas fa-times text-danger"></i> Chiffre');
        }

        if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
            force++;
            criteres.push('<i class="fas fa-check text-success"></i> Caractère spécial');
        }

        // Déterminer niveau de force
        const niveaux = [
            { label: 'Très faible', color: 'danger', width: '20%' },
            { label: 'Faible', color: 'warning', width: '40%' },
            { label: 'Moyen', color: 'info', width: '60%' },
            { label: 'Fort', color: 'success', width: '80%' },
            { label: 'Très fort', color: 'success', width: '100%' }
        ];

        const niveau = niveaux[Math.min(force, 4)];

        // Afficher barre de progression
        strengthDiv.innerHTML = `
            <div class="mb-2">
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-${niveau.color}" 
                         style="width: ${niveau.width}"
                         role="progressbar"></div>
                </div>
                <small class="text-${niveau.color}">Force: ${niveau.label}</small>
            </div>
            <div class="small text-muted">
                ${criteres.join(' • ')}
            </div>
        `;
    });

    // ============================================
    // 3. VÉRIFICATION CORRESPONDANCE MOTS DE PASSE
    // ============================================
    password2Input.addEventListener('input', function() {
        const password1 = password1Input.value;
        const password2 = this.value;
        const feedback = document.getElementById('password2-feedback');

        if (!password2) {
            feedback.textContent = '';
            this.classList.remove('is-valid', 'is-invalid');
            return;
        }

        if (password1 === password2) {
            feedback.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Les mots de passe correspondent</span>';
            this.classList.add('is-valid');
            this.classList.remove('is-invalid');
        } else {
            feedback.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> Les mots de passe ne correspondent pas</span>';
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        }
    });

    // ============================================
    // 4. TOGGLE VISIBILITÉ MOT DE PASSE
    // ============================================
    document.getElementById('toggle-password1').addEventListener('click', function() {
        togglePasswordVisibility('id_password1', 'eye-icon1');
    });

    document.getElementById('toggle-password2').addEventListener('click', function() {
        togglePasswordVisibility('id_password2', 'eye-icon2');
    });

    function togglePasswordVisibility(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // ============================================
    // 5. VALIDATION AVANT SOUMISSION
    // ============================================
    form.addEventListener('submit', function(e) {
        let isValid = true;

        // Vérifier champs requis
        const requiredFields = ['first_name', 'last_name', 'email', 'telephone', 'password1', 'password2'];
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });

        // Vérifier correspondance mots de passe
        if (password1Input.value !== password2Input.value) {
            password2Input.classList.add('is-invalid');
            isValid = false;
        }

        // Vérifier conditions acceptées
        const conditions = document.getElementById('accepter_conditions');
        if (!conditions.checked) {
            alert('Vous devez accepter les conditions d\'utilisation pour continuer.');
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            // Désactiver bouton pour éviter double soumission
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Création en cours...';
        }
    });

    // ============================================
    // 6. AUTO-DISMISS MESSAGES APRÈS 5 SECONDES
    // ============================================
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    });
});
</script>

<!-- CSS personnalisé -->
<style>
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-control.is-valid {
    border-color: #198754;
}

.form-control.is-invalid {
    border-color: #dc3545;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.card {
    border: none;
    border-radius: 10px;
}

#password-strength {
    margin-top: 8px;
}

.progress {
    background-color: #e9ecef;
}

.input-group .btn-outline-secondary {
    border-color: #ced4da;
}

.input-group .btn-outline-secondary:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
}

/* Animation pour messages */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert {
    animation: slideDown 0.3s ease-out;
}
</style>

{% endblock %}