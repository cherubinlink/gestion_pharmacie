{% extends 'navigateur/base.html' %}
{% load static %}

{% block title %}Connexion - {{ page_title|default:"Se connecter" }}{% endblock %}

{% block pharmacie %}

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">

      <!-- Logo -->
      <div class="text-center mb-4">
        <a href="{% url 'gestion_compte:connexion' %}">
          <img src="{% static 'assets/images/logo-dark.svg' %}" alt="Logo" style="max-width:150px;">
        </a>
      </div>

      <!-- Card principale -->
      <div class="card shadow-sm">
        <div class="card-body p-4">

          <h3 class="mb-1 text-center"><b>Connexion</b></h3>
          <p class="text-center text-muted small mb-4">
            Accédez à votre espace de gestion
          </p>

          <!-- Messages Django -->
          {% if messages %}
            <div id="messages-container">
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                  <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <!-- Formulaire de connexion -->
          <form method="POST" id="form-connexion" novalidate>
            {% csrf_token %}

            <!-- Email -->
            <div class="mb-3">
              <label class="form-label">
                Adresse email <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-envelope"></i>
                </span>
                <input type="email" 
                       name="username" 
                       id="id_username"
                       class="form-control {% if form.username.errors %}is-invalid{% endif %}" 
                       placeholder="exemple@email.com"
                       value="{{ form.username.value|default:'' }}"
                       autocomplete="email"
                       autofocus
                       required>
              </div>
              {% if form.username.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.username.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Mot de passe -->
            <div class="mb-3">
              <label class="form-label">
                Mot de passe <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-lock"></i>
                </span>
                <input type="password" 
                       name="password" 
                       id="id_password"
                       class="form-control {% if form.password.errors %}is-invalid{% endif %}" 
                       placeholder="••••••••"
                       autocomplete="current-password"
                       required>
                <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                  <i class="fas fa-eye" id="eye-icon"></i>
                </button>
              </div>
              {% if form.password.errors %}
                <div class="invalid-feedback d-block">
                  {% for error in form.password.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Se souvenir + Mot de passe oublié -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       name="remember_me" 
                       id="remember_me">
                <label class="form-check-label small" for="remember_me">
                  Se souvenir de moi
                </label>
              </div>
              <a href="" class="text-primary small">
                <i class="fas fa-question-circle me-1"></i>
                Mot de passe oublié ?
              </a>
            </div>

            <!-- Erreurs non-field -->
            {% if form.non_field_errors %}
              <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}

            <!-- Bouton de connexion -->
            <div class="d-grid mb-3">
              <button type="submit" class="btn btn-primary btn-lg" id="btn-submit">
                <i class="fas fa-sign-in-alt me-2"></i> Se connecter
              </button>
            </div>

            <!-- Lien inscription -->
            <p class="text-center text-muted small mb-0">
              Vous n'avez pas de compte ? 
              <a href="{% url 'gestion_compte:inscription' %}" class="text-primary fw-bold">
                Créer un compte
              </a>
            </p>

          </form>

        </div>
      </div>

      <!-- Statistiques (optionnel) -->
      {% if stats %}
      <div class="card shadow-sm mt-3">
        <div class="card-body p-3">
          <div class="row text-center">
            <div class="col-6">
              <h5 class="mb-0 text-primary">{{ stats.total_utilisateurs }}</h5>
              <small class="text-muted">Utilisateurs</small>
            </div>
            <div class="col-6">
              <h5 class="mb-0 text-success">{{ stats.connexions_aujourd_hui }}</h5>
              <small class="text-muted">Connexions aujourd'hui</small>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Aide -->
      <div class="card shadow-sm mt-3">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <i class="fas fa-info-circle text-info me-2 fs-4"></i>
            <div class="small">
              <strong>Besoin d'aide ?</strong><br>
              Contactez le support : <a href="mailto:support@example.com">support@example.com</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="text-center mt-4">
        <p class="m-0 text-muted small">
          © {{ now|date:"Y" }} – Gestion Pharmacie – Tous droits réservés
        </p>
      </div>

    </div>
  </div>
</div>

<!-- JavaScript pour amélioration UX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-connexion');
    const btnSubmit = document.getElementById('btn-submit');
    const passwordInput = document.getElementById('id_password');
    const emailInput = document.getElementById('id_username');

    // ============================================
    // 1. TOGGLE VISIBILITÉ MOT DE PASSE
    // ============================================
    document.getElementById('toggle-password').addEventListener('click', function() {
        const icon = document.getElementById('eye-icon');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // ============================================
    // 2. VALIDATION EN TEMPS RÉEL
    // ============================================
    
    // Validation email
    emailInput.addEventListener('blur', function() {
        const email = this.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email && !emailRegex.test(email)) {
            this.classList.add('is-invalid');
            this.classList.remove('is-valid');
        } else if (email) {
            this.classList.add('is-valid');
            this.classList.remove('is-invalid');
        } else {
            this.classList.remove('is-valid', 'is-invalid');
        }
    });

    // Validation mot de passe
    passwordInput.addEventListener('input', function() {
        if (this.value.length > 0) {
            this.classList.add('is-valid');
            this.classList.remove('is-invalid');
        } else {
            this.classList.remove('is-valid', 'is-invalid');
        }
    });

    // ============================================
    // 3. GESTION SESSION "SE SOUVENIR"
    // ============================================
    const rememberCheckbox = document.getElementById('remember_me');
    
    // Charger l'email sauvegardé
    const savedEmail = localStorage.getItem('remembered_email');
    if (savedEmail) {
        emailInput.value = savedEmail;
        rememberCheckbox.checked = true;
    }

    // Sauvegarder/Supprimer selon checkbox
    form.addEventListener('submit', function() {
        if (rememberCheckbox.checked) {
            localStorage.setItem('remembered_email', emailInput.value);
        } else {
            localStorage.removeItem('remembered_email');
        }
    });

    // ============================================
    // 4. VALIDATION AVANT SOUMISSION
    // ============================================
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Vérifier email
        if (!emailInput.value.trim()) {
            emailInput.classList.add('is-invalid');
            isValid = false;
        }
        
        // Vérifier mot de passe
        if (!passwordInput.value) {
            passwordInput.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            
            // Afficher message d'erreur
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Veuillez remplir tous les champs obligatoires.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const messagesContainer = document.getElementById('messages-container');
            if (messagesContainer) {
                messagesContainer.innerHTML = alertHtml;
            } else {
                form.insertAdjacentHTML('afterbegin', alertHtml);
            }
            
            // Scroll vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            // Désactiver le bouton pour éviter double soumission
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Connexion en cours...';
        }
    });

    // ============================================
    // 5. ENTER POUR SOUMETTRE
    // ============================================
    emailInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            passwordInput.focus();
        }
    });

    passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            form.submit();
        }
    });

    // ============================================
    // 6. AUTO-DISMISS MESSAGES APRÈS 5 SECONDES
    // ============================================
    const alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
    alerts.forEach(alert => {
        // Ne pas auto-fermer les messages d'erreur
        if (!alert.classList.contains('alert-danger')) {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        }
    });

    // ============================================
    // 7. FOCUS AUTOMATIQUE SUR PREMIER CHAMP VIDE
    // ============================================
    if (!emailInput.value) {
        emailInput.focus();
    } else if (!passwordInput.value) {
        passwordInput.focus();
    }

    // ============================================
    // 8. PRÉVENIR COPIER-COLLER DU MOT DE PASSE (Optionnel)
    // ============================================
    // Décommenter si vous voulez empêcher le copier-coller
    /*
    passwordInput.addEventListener('paste', function(e) {
        e.preventDefault();
        alert('Le collage est désactivé pour des raisons de sécurité.');
    });
    */

    // ============================================
    // 9. DÉTECTION CAPS LOCK
    // ============================================
    passwordInput.addEventListener('keyup', function(e) {
        if (e.getModifierState && e.getModifierState('CapsLock')) {
            // Afficher avertissement Caps Lock
            if (!document.getElementById('caps-lock-warning')) {
                const warning = document.createElement('div');
                warning.id = 'caps-lock-warning';
                warning.className = 'text-warning small mt-1';
                warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Attention: Caps Lock est activé';
                passwordInput.parentElement.parentElement.appendChild(warning);
            }
        } else {
            // Supprimer avertissement
            const warning = document.getElementById('caps-lock-warning');
            if (warning) {
                warning.remove();
            }
        }
    });

    // ============================================
    // 10. ANALYTICS (Optionnel)
    // ============================================
    // Enregistrer tentative de connexion pour analytics
    form.addEventListener('submit', function() {
        if (typeof gtag !== 'undefined') {
            gtag('event', 'login_attempt', {
                'method': 'email'
            });
        }
    });
});
</script>

<!-- CSS personnalisé -->
<style>
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-control.is-valid {
    border-color: #198754;
}

.form-control.is-invalid {
    border-color: #dc3545;
}

.input-group-text {
    background-color: #f8f9fa;
    border-right: none;
}

.input-group .form-control {
    border-left: none;
}

.input-group:focus-within .input-group-text {
    border-color: #0d6efd;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.card {
    border: none;
    border-radius: 10px;
}

#toggle-password {
    border-left: none;
}

.input-group .btn-outline-secondary {
    border-color: #ced4da;
}

.input-group .btn-outline-secondary:hover {
    background-color: #e9ecef;
    border-color: #ced4da;
}

/* Animation pour messages */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert {
    animation: slideDown 0.3s ease-out;
}

/* Style pour le loader du bouton */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 576px) {
    .card-body {
        padding: 1.5rem !important;
    }
    
    h3 {
        font-size: 1.5rem;
    }
}
</style>

{% endblock %}